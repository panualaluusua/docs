const fs = require('fs');
const path = require('path');

// Lue kaikki docs-kansiot (poislukien piilotetut kansiot)
const docsRoot = path.join(__dirname, 'docs');
const projects = fs.readdirSync(docsRoot).filter(name =>
  fs.statSync(path.join(docsRoot, name)).isDirectory() && !name.startsWith('.')
);

// Luo plugin-instanssit
const plugins = projects.map(project => ([
  '@docusaurus/plugin-content-docs',
  {
    id: project,
    path: `docs/${project}`,
    routeBasePath: project, // URL: /projekti1/
    sidebarPath: require.resolve(`./docs/${project}/sidebars.js`),
  }
]));

// Luo navbar-linkit
const navbarItems = projects.map(project => ({
  to: `/${project}/`,
  label: project,
  position: 'left'
}));

// Generoi projektikohtaiset sidebars.js-tiedostot
docsRoot && projects.forEach(project => {
  const sidebarPath = path.join(docsRoot, project, 'sidebars.js');
  const sidebarContent = `module.exports = {\n  sidebar: [\n    { type: 'autogenerated', dirName: '.' }\n  ],\n};\n`;
  fs.writeFileSync(sidebarPath, sidebarContent);
});

// Luo uusi docusaurus.config.js
const config = `module.exports = {
  title: 'Panun Dokumentaatio',
  url: 'https://panualaluusua.fi',
  baseUrl: '/docs/',
  favicon: 'img/favicon.ico',
  organizationName: 'panualaluusua',
  projectName: 'docs',
  themeConfig: {
    navbar: {
      title: 'Panun Dokumentaatio',
      logo: {
        alt: 'Panun Dokumentaatio logo',
        src: 'img/logo.svg',
        href: 'docs/',
      },
      items: ${JSON.stringify(navbarItems, null, 2)},
    },
    footer: {
      style: 'dark',
      copyright: "Copyright © " + new Date().getFullYear() + " Panu Alaluusua",
    },
  },
  plugins: ${JSON.stringify(plugins, null, 2)},
  presets: [
    [
      '@docusaurus/preset-classic',
      {
        theme: {
          customCss: require.resolve('./src/css/custom.css'),
        },
      },
    ],
  ],
};
`;

fs.writeFileSync(path.join(__dirname, 'docusaurus.config.js'), config);
console.log('docusaurus.config.js ja projektikohtaiset sidebars.js:t päivitetty automaattisesti!');
